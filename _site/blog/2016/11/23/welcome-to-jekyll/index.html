<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Text classification using CNN : Example</title>
    <meta name="description" content="This site is designed to contribute to the growing deep learning community. Moslyt focuses on application of deep learning on unstructured data.
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://yourdomain.com/blog/2016/11/23/welcome-to-jekyll">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Deep Learning</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
          <a class="page-link" href="/blog/index.html">Nitin Agarwal's Blog</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Text classification using CNN : Example</h1>
    <p class="post-meta">Nov 23, 2016</p>
  </header>

  <article class="post-content">
    <p>Suppose we have two sentences for our classification task.</p>

<p>Sentence 1 : The camera quality is very good<br />
Sentence 2 : The battery life is good</p>

<p>Here we have two sentences of length 6 and 5 respectively.<br />
We also assume that their are two classes for our classification model, Positive and Negative.</p>

<h3 id="step-1--building-the-vocabulary">Step 1 : Building the vocabulary</h3>
<p>Since the sentences are of different length, we pad our sentences with special <code>&lt;PAD&gt;</code> token.
So now we have our sentences modified as :<br />
Sentence 1 : the camera quality is very good<br />
Sentence 2 : the battery life is good <code>&lt;PAD&gt;</code>.
Now, both the sentences are of same length. We proceed to build the vocabulary index.<br />
Vocabulary index is a mapping of integer to each unique word in the corpus.
In our case, size of vocabulary index will be 9, since there are 9 unique tokens.
In tensorflow, tensorflow.contrib.learn.preprocessing.VocabularyProcessor is used for building the vocabulary.  </p>

<p>For our case, suppose the vocabulary index is :
<code>&lt;PAD&gt;</code> the camera quality is very good battery life  </p>

<p>Next, each sentence is converted into vector of integers.
Sentence 1 : [1, 2, 3, 4, 5, 6]
Sentence 2 : [1, 7, 8, 4, 6, 0]</p>

<p>I will try to explain the network in the same order as it is in code.  </p>

<ol>
  <li>Embedding Layer</li>
  <li>Convolution Layer</li>
  <li>Pooliing Layer</li>
  <li>Dropout Layer</li>
  <li>Output Layer</li>
</ol>

<h2 id="embedding-layer">Embedding Layer</h2>

<h3 id="configurable-parameters-for-embedding-layer">Configurable parameters for embedding layer</h3>

<ul>
  <li><strong>batch_size</strong> = 2 (Since we have only two sentences here)  </li>
  <li><strong>sequence length</strong> = 6 (Max length of the senteces)  </li>
  <li><strong>num_classes</strong>       = 2 (Number of output classes. Positive and negative in our case)  </li>
  <li><strong>vocabulary size (V)</strong> = 9  </li>
</ul>

<h3 id="trainable-parameters-for-embedding-layer">Trainable parameters for embedding layer</h3>

<ul>
  <li><strong>Embedding vector size (E)</strong> = 128 (Size of the embedding vector)  </li>
  <li><strong>Embedding matrix (W) of shape</strong> = [V * E] = [9 * 128]</li>
</ul>

<h3 id="input">Input</h3>
<p><strong>shape of input (input_x)</strong> = [batch_size, sequence_length] = [2, 6]<br />
<strong>shape of input (input_y)</strong> = [batch_size, num_classes] = [2, 2]  </p>

<h3 id="working-of-embedding-layer">Working of embedding layer</h3>

<p>As per the code in the <a href="http://www.wildml.com/2015/12/implementing-a-cnn-for-text-classification-in-tensorflow/">wildml blog</a>:  </p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">input_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;input_x&quot;</span><span class="p">)</span></code></pre></div>

<p>Input to the embedding layer is a tuple whose length is equal to the batch size, i.e, number of sentences in a batch.<br />
Each element of the tuple is an array of numbers, representing sentence in the form of indexes into vocabulary.<br />
For example : <br />
input_x = ( ## Figure)  </p>

<h3 id="embedding-lookup">Embedding Lookup</h3>
<p>Statement from the <a href="http://www.wildml.com/2015/12/implementing-a-cnn-for-text-classification-in-tensorflow/">wildml blog</a></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">embedded_chars</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">embedding_lookup</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_x</span><span class="p">)</span></code></pre></div>

<p>This statement takes as input, input_x from the previous step.<br />
For each sentence, and for each word, it looks up (indexes) the embedding matrix (which is 9 * 128 in our case) (w) and returns the corresponding embedding vector for each word of each sentence.<br />
When i printed the variable <code>embedded_chars</code>, it is actually a list structured as follows :   </p>

<ul>
  <li>embedded_chars is a list of size 1,  </li>
  <li>its 0th element is a list of size batch_size, i.e, number of sentences, (2 for this ex)  </li>
  <li>each element of this list is a list of size sequence_length, (6 for this ex)</li>
  <li>and, each element of this list is a list of size embedding vector (128 for this ex.)  </li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">[</span>
	<span class="p">[</span>
		<span class="p">[</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">.......</span><span class="mi">127</span><span class="p">]</span> <span class="p">],</span>
		<span class="p">[</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">.......</span><span class="mi">127</span><span class="p">]</span> <span class="p">],</span>
		<span class="p">[</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">.......</span><span class="mi">127</span><span class="p">]</span> <span class="p">],</span>
		<span class="p">[</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">.......</span><span class="mi">127</span><span class="p">]</span> <span class="p">],</span>
		<span class="p">[</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">.......</span><span class="mi">127</span><span class="p">]</span> <span class="p">],</span>
		<span class="p">[</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">.......</span><span class="mi">127</span><span class="p">]</span> <span class="p">],</span>
	<span class="p">],</span>
	<span class="p">[</span>
		<span class="ow">and</span> <span class="n">so</span> <span class="n">on</span><span class="o">.</span>
	<span class="p">]</span>
<span class="p">]</span></code></pre></div>

<p>If this looks difficult, it can be understood with the following diagram,</p>

<h3 id="figure">Figure</h3>

<p>Here, the shape of tensor is <code>[batch_size, sequence_length, embedding_vector_length]</code>, i.e, <code>[2 * 9 * 128]</code>. <br />
Each element of the word vector is a real value. In the next satement of the blog, i.e,</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">embedded_chars_expanded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedded_chars</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></code></pre></div>

<p>tensor is reshaped to <code>[batch_size, sequence_length, embedding_vector_length, 1]</code>,<br />
i.e, <code>[2 * 9 * 128 * 1]</code>. So that, each element is itself a list of size 1, instead of a real number.<br />
This completes the explanation of embedding layer</p>

<h3 id="output-of-embedding-layer-">Output of embedding layer :</h3>

<ul>
  <li>Tensor of shape : <code>[batch_size, sequence_length, embedding_vector_length, 1]</code>, i.e, <code>[2 * 9 * 128 * 1]</code>.
Next layer in the model is the convolution layer.</li>
</ul>

<h2 id="convolution-layer">Convolution Layer</h2>

<h3 id="configurable-parameters-for-convolution-layer">Configurable parameters for convolution layer</h3>

<ul>
  <li><strong>filter_sizes</strong> : 3, 4, 5</li>
  <li><strong>num_filters</strong>: 128</li>
  <li><strong>Stride length</strong> : </li>
  <li><strong>Padding</strong> : <br />
As oppossed to 2D filters in images, here in text classification we use 1D filters. We will be using filters of sizes 3,4,5. First we will go through the process of a single filter. Same will work for the other two sizes. Later we will see, how to merge the output from all the three filter sizes.</li>
</ul>

<h3 id="trainable-parameters-of-convolution-layer">Trainable parameters of convolution layer</h3>
<ul>
  <li><strong>Weight matrix (W)</strong> : its shape is same as shape of filter.</li>
  <li><strong>Bias(b)</strong> : Since there are 128 filters, there will be 128 bias values.</li>
</ul>

<p><strong>Now, what is the shape of filter ?</strong>
Lets take filter of size, <code>filter_size = 3</code>. In this case, shape of the filter is <code>[filter_height, fiter_width]</code> or <code>[filter_size, embedding_vector_len]</code> or <code>[3 * 128]</code>. This means that the filter sees 3 words (or embedding vectors) at  a time, and based on the stride keeps seeing the 3 word vectors.<br />
We have only one input channel, therefore, num_input_channels = 1<br />
Number of output channels or Number of filters is 128.
Therefore, shape of the filter tensor becomes : <code>[filter_size, embedding_vector_len, num_input_channels, num_filters] = [ 3 * 128 * 1 * 128]</code>
The following figure shows the mapping between input matrix and filter of size 3 : </p>

<h3 id="figure-1">Figure</h3>

<p>I will explain how to apply convolution filter on the input in the next step, but, before that let us see how to compute the output shape for this filter of size 3.  </p>

<p><strong>Now, what is the shape of output filter ?</strong><br />
For 1D case, as in text,<br />
<code>out_rows = (W1- F + 2 * P) / S + 1</code><br />
where,<br />
W1 = sequence_length (Number of input words) = 6 (in our case)<br />
F = height of filter or filter size = 3 (in our case)<br />
P = padding = 0 (in our case)<br />
Stride = 1 (in our case)  </p>

<p>Therefore,<br />
<code>out_rows = (6 - 3 + 2 * 0) / 1 + 1 = 4</code><br />
Since the filter moves only in 1D, shape of output = 4 * 1, for a single sentence with a fiter_size = 3 and for one output_channel.<br />
Now, since we have batch of sentences and num_filters = 128, we get 4 * 1 outputs for each combination. Therefore, shape of output tensor for fiter_size (3) is<br />
<code>[batch_size * 4 * 1 * num_filters] = [2 * 4 * 1 * 128]</code>  </p>

<p>Similarly, we can compute the output shapes for filters of size 4 and 5 as follows : <br />
<strong>For  filter_size (4)</strong> <code>(6 - 4 + 2 * 0) / 1 + 1 = 3</code> or <code>[2 * 3 * 1 * 128]</code><br />
<strong>For  filter_size (5)</strong> <code>(6 - 5 + 2 * 0) / 1 + 1 = 2</code> or <code>[2 * 2 * 1 * 128]</code><br />
Now let us see a simple calculation showing how filter is applied to input and what is the role of weight matrix and bias.  </p>

<h3 id="working-of-convolution-layer">Working of convolution layer</h3>

<h4 id="input-1">Input</h4>
<ul>
  <li>Output of the expanded embedding lookup step. Its shape is<br />
<code>[batch_size, sequence_length, embedding_vector_length, 1]</code>, i.e, <code>[2 * 9 * 128 * 1]</code>
####Filter </li>
</ul>

<p>You’ll find this post in your <code>_posts</code> directory. Go ahead and edit it and re-build the site to see your changes. You can rebuild the site in many different ways, but the most common way is to run <code>jekyll serve --watch</code>, which launches a web server and auto-regenerates your site when a file is updated.</p>

<p>To add new posts, simply add a file in the <code>_posts</code> directory that follows the convention <code>YYYY-MM-DD-name-of-post.ext</code> and includes the necessary front matter. Take a look at the source for this post to get an idea about how it works.</p>

<p>Jekyll also offers powerful support for code snippets:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">print_hi</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">&quot;Hi, </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
<span class="n">print_hi</span><span class="p">(</span><span class="s1">&#39;Tom&#39;</span><span class="p">)</span>
<span class="c1">#=&gt; prints &#39;Hi, Tom&#39; to STDOUT.</span></code></pre></div>

<p>Check out the [Jekyll docs][jekyll] for more info on how to get the most out of Jekyll. File all bugs/feature requests at <a href="https://github.com/jekyll/jekyll">Jekyll’s GitHub repo</a>. If you have questions, you can ask them on <a href="https://github.com/jekyll/jekyll-help">Jekyll’s dedicated Help repository</a>.</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Deep Learning</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Deep Learning</li>
          <li><a href="mailto:agar.nitin86@gmail.com">agar.nitin86@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/agarnitin86">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">agarnitin86</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/agarnitin86">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">agarnitin86</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">This site is designed to contribute to the growing deep learning community. Moslyt focuses on application of deep learning on unstructured data.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
